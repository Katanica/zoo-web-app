<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ZOO WEB APP - Obaveze (pregled)</title>

    <style>
        :root{
            --primary:#2c3e50;
            --secondary:#3498db;
            --danger:#e74c3c;
            --success:#27ae60;
            --light:#ecf0f1;
            --dark:#2c3e50;
        }

        *{ box-sizing:border-box; margin:0; padding:0; }

        body{
            font-family:'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding:2rem 1rem;
            min-height:100vh;
            color:var(--dark);
        }

        header{ text-align:center; margin-bottom:2rem; }
        h1{ color:var(--primary); }

        .back-btn{
            display:inline-block;
            margin-bottom:1rem;
            background:var(--secondary);
            color:#fff;
            padding:0.6rem 1.2rem;
            border-radius:8px;
            text-decoration:none;
            font-weight:600;
        }

        .container{
            max-width:1100px;
            margin:auto;
            display:grid;
            grid-template-columns:1fr;
            gap:1.5rem;
        }

        .card{
            background:#fff;
            padding:1.5rem;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }

        .toolbar{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:1rem;
            margin-bottom:1rem;
            flex-wrap:wrap;
        }

        .muted{ color:#777; font-size:0.9rem; }

        .input, .select{
            padding:0.6rem;
            border-radius:6px;
            border:1px solid #ccc;
            min-width:220px;
            background:#fff;
        }
        .select{ min-width:200px; }

        .btn{
            padding:0.6rem 1rem;
            border:none;
            border-radius:6px;
            background:var(--success);
            color:#fff;
            font-weight:600;
            cursor:pointer;
        }

        .list{
            display:flex;
            flex-direction:column;
            gap:0.7rem;
            margin-top:0.8rem;
        }

        .stavka{
            background:var(--light);
            padding:0.9rem 1rem;
            border-radius:12px;
            border-left:4px solid var(--secondary);
        }

        .row-top{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:1rem;
            flex-wrap:wrap;
        }

        .title{
            font-weight:800;
            color:var(--primary);
            font-size:1.05rem;
        }

        .badge{
            font-size:0.78rem;
            font-weight:800;
            padding:0.25rem 0.55rem;
            border-radius:999px;
            background:#eef3ff;
            color:#2c58b8;
            display:inline-block;
        }

        .line{
            margin-top:0.35rem;
            color:#444;
            font-size:0.95rem;
        }

        .actions{
            margin-top:0.7rem;
            display:flex;
            gap:0.5rem;
            flex-wrap:wrap;
            align-items:center;
        }

        .btn-mini{
            border:none;
            border-radius:10px;
            padding:0.45rem 0.7rem;
            cursor:pointer;
            font-weight:800;
            font-size:0.9rem;
            background:var(--success);
            color:#fff;
        }

        .btn-mini:disabled{ opacity:0.6; cursor:not-allowed; }

        .empty{
            color:#999;
            padding:0.9rem 0.2rem;
            text-align:center;
        }
    </style>
</head>

<body>
<header>
    <a class="back-btn" href="index.html">POČETNA</a>
    <h1>ZOO WEB APP – Obaveze (pregled)</h1>
</header>

<div class="container">
    <div class="card">
        <div class="toolbar">
            <div>
                <h3 style="border:none;margin:0;color:var(--primary)">Pregled obaveza</h3>
                <div class="muted">Bez rasporeda i datuma – samo lista (Aktivne/Prošle).</div>
            </div>
            <button id="btn-refresh" class="btn" type="button">Osvježi</button>
        </div>

        <div class="toolbar" style="margin-top:0.2rem">
            <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
                <select id="status-filter" class="select">
                    <option value="aktivne">Aktivne (PLANIRANO)</option>
                    <option value="prosle">Prošle (OBAVLJENO)</option>
                </select>
                <input id="search" class="input" type="text" placeholder="Pretraži (tip, komentar, životinja, radnik...)">
            </div>
            <div class="muted" id="count"></div>
        </div>

        <div id="list" class="list"></div>
        <div id="empty" class="empty" style="display:none;">Nema obaveza za prikaz.</div>
    </div>
</div>

<script>
    const API_BASE = "/api/obaveza";

    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const countEl = document.getElementById("count");

    const statusFilter = document.getElementById("status-filter");
    const search = document.getElementById("search");
    const btnRefresh = document.getElementById("btn-refresh");

    function escapeHtml(str){
        return String(str ?? "")
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#039;");
    }

    function parseLocalDateTime(s){
        if (!s) return null;
        s = String(s).trim().replace(/Z$/, "").replace(/([+-]\d{2}:\d{2})$/, "");
        const [datePart, timePart = "00:00:00"] = s.split("T");
        const [y, m, d] = datePart.split("-").map(Number);
        const parts = timePart.split(":");
        const hh = Number(parts[0] || 0);
        const mm = Number(parts[1] || 0);
        const ss = Number(String(parts[2] || "0").split(".")[0]);
        const dt = new Date(y, m - 1, d, hh, mm, ss);
        return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function fmtTimeOnly(s){
        const d = parseLocalDateTime(s);
        if (!d) return "";
        return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    function nazivZivotinje(o){
        if (o.jedinka) return `${o.jedinka.hrvatskiNaziv} (${o.jedinka.nadimak})`;
        if (o.skupina) return `${o.skupina.hrvatskiNaziv} (skupina)`;
        return "—";
    }

    function nazivRadnika(o){
        if (!o.radnik) return "Nije dodijeljen radnik";
        return `${o.radnik.ime} ${o.radnik.prezime}`;
    }

    function getId(o){
        return o?.id ?? o?.obavezaId ?? o?.ID ?? null;
    }

    function getUrl(){
        return statusFilter.value === "prosle"
            ? `${API_BASE}/prosle`
            : `${API_BASE}/aktivne`;
    }

    function matchesSearch(o, q){
        if (!q) return true;
        const hay = [
            getId(o),
            o.tip,
            o.komentar,
            o.jedinka?.hrvatskiNaziv,
            o.jedinka?.nadimak,
            o.skupina?.hrvatskiNaziv,
            o.radnik?.ime,
            o.radnik?.prezime
        ].join(" ").toLowerCase();
        return hay.includes(q);
    }

    async function zavrsiObavezu(id, btn){
        if (!id){
            alert("Ne mogu naći ID obaveze (provjeri JSON).");
            return;
        }
        if (!confirm("Označiti obavezu kao OBAVLJENO?")) return;

        try{
            btn.disabled = true;
            const res = await fetch(`${API_BASE}/${id}/zavrsi`, { method:"PATCH" });
            if (!res.ok){
                const t = await res.text();
                throw new Error(t || `Greška ${res.status}`);
            }
            await ucitaj();
        }catch(e){
            alert("Ne mogu završiti obavezu: " + e.message);
        }finally{
            btn.disabled = false;
        }
    }

    function renderItem(o){
        const id = getId(o);
        const tip = escapeHtml(o.tip);
        const zivotinja = escapeHtml(nazivZivotinje(o));
        const radnik = escapeHtml(nazivRadnika(o));
        const komentar = escapeHtml(o.komentar || "");

        // NEMA datuma — samo vrijeme (ako želiš i ovo maknuti, obriši badge blok)
        const t = fmtTimeOnly(o.vrijemeOd);
        const badge = t ? `<span class="badge">${escapeHtml(t)}</span>` : `<span class="badge">—</span>`;

        const isProsle = (statusFilter.value === "prosle");

        const akcija = !isProsle
            ? `<div class="actions">
           <button class="btn-mini" type="button" onclick="zavrsiObavezu(${id}, this)">Obavljeno</button>
         </div>`
            : "";

        return `
      <div class="stavka">
        <div class="row-top">
          <div class="title">${tip}</div>
          ${badge}
        </div>

        <div class="line"><strong>ŽIVOTINJA:</strong> ${zivotinja}</div>
        <div class="line"><strong>RADNIK:</strong> ${radnik}</div>
        ${komentar ? `<div class="line"><strong>KOMENTAR:</strong> ${komentar}</div>` : ""}

        ${akcija}
      </div>
    `;
    }

    async function ucitaj(){
        listEl.innerHTML = "";
        emptyEl.style.display = "none";
        countEl.textContent = "";

        const res = await fetch(getUrl());
        const data = await res.json();

        const q = search.value.trim().toLowerCase();
        const filtered = data.filter(o => matchesSearch(o, q));

        countEl.textContent = `Ukupno: ${filtered.length}`;

        if (filtered.length === 0){
            emptyEl.style.display = "block";
            return;
        }

        listEl.innerHTML = filtered.map(renderItem).join("");
    }

    btnRefresh.addEventListener("click", ucitaj);
    statusFilter.addEventListener("change", ucitaj);
    search.addEventListener("input", ucitaj);
    document.addEventListener("DOMContentLoaded", ucitaj);
</script>
</body>
</html>
